# Supabaseデータベースセットアップガイド

## 現在の状況

Supabaseデータベースの確認テストを実行した結果、以下の状況が判明しました：

### ✅ 正常に動作しているもの
- **基本接続**: Supabaseへの接続は正常
- **profiles テーブル**: 存在し、10件のユーザーデータが保存済み
- **tenants テーブル**: 存在し、2件のテナントデータが保存済み
  - PM (プライムメソッド)
  - TM (トップメソッド)

### ❌ 不足しているテーブル
- **assignments** (課題テーブル)
- **assignment_submissions** (課題提出テーブル)
- **study_records** (学習記録テーブル)
- **messages** (メッセージテーブル)

### 🔧 認証状態
- 現在未ログイン状態（Auth session missing!）

## 必要な作業

### 1. 不足しているテーブルの作成

Supabase管理画面でSQLを実行する必要があります：

1. **Supabase Dashboard** にアクセス
   - URL: https://supabase.com/dashboard
   - プロジェクト: `wjpcfsjtjgxvhijczxnj`

2. **SQL Editor** を開く
   - 左サイドバーから「SQL Editor」を選択

3. **SQLファイルの内容を実行**
   - `create-missing-tables.sql` の内容をコピー&ペースト
   - 「Run」ボタンをクリックして実行

### 2. 実行するSQL内容

以下のテーブルとサンプルデータが作成されます：

#### テーブル
- `assignments` - 課題管理
- `assignment_submissions` - 課題提出管理
- `study_records` - 学習記録
- `messages` - メッセージ機能

#### サンプルデータ
- **課題**: 3件（数学、英語、物理）
- **学習記録**: 4件（各生徒の学習履歴）
- **メッセージ**: 3件（個別メッセージ、全体通知、システム通知）

#### セキュリティ設定
- Row Level Security (RLS) ポリシー
- テナント別データ分離
- ロール別アクセス制御

### 3. 確認方法

SQLを実行後、以下のコマンドで確認できます：

```bash
node test-supabase-data.js
```

期待される結果：
- 全テーブルが「✅ テーブル存在確認」と表示される
- サンプルデータが正しく表示される

## 現在のユーザーデータ

### プロファイル (10件)
```
1. ID: PM-0100, 名前: er, ロール: STUDENT, テナント: PM
2. ID: PM-0101, 名前: shishanxintai20, ロール: STUDENT, テナント: PM
3. ID: PM-0102, 名前: minnanoakogare1023, ロール: STUDENT, テナント: PM
... (他7件)
```

### テナント (2件)
```
1. コード: PM, 名前: プライムメソッド
2. コード: TM, 名前: トップメソッド
```

## 次のステップ

1. **SQLの実行**: `create-missing-tables.sql` をSupabase管理画面で実行
2. **動作確認**: テストスクリプトで全テーブルの存在を確認
3. **アプリケーションテスト**: 実際のアプリでデータの読み書きをテスト
4. **認証テスト**: ログイン機能でユーザー認証をテスト

## トラブルシューティング

### エラーが発生した場合
1. **権限エラー**: Supabaseプロジェクトの管理者権限を確認
2. **テーブル競合**: 既存テーブルがある場合は `DROP TABLE` で削除後再実行
3. **外部キー制約**: `tenants` テーブルが存在することを確認

### 接続エラーの場合
1. **URL確認**: `https://wjpcfsjtjgxvhijczxnj.supabase.co`
2. **APIキー確認**: 匿名キーが正しく設定されているか確認
3. **ネットワーク**: インターネット接続を確認